!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){if(r(1),"undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");AFRAME.registerComponent("bricks",{schema:{src:{type:"model"},steps:{type:"int"}},init:function(){this.model=null,this.ldrawLoader=new THREE.LDrawLoader,this.isBuggy="1.0.4-blocks-mod"!==AFRAME.version},update:function(e){this.data.src!==e.src&&(this.resetMesh(),this.loadModel(this.data.src,this.data.steps)),this.data.steps!==e.steps&&this.model&&this.setStep(this.data.steps)},remove:function(){this.model&&this.resetMesh()},resetMesh:function(){this.el.removeObject3D("mesh")},pause:function(){this.isBuggy&&(console.log("Three.js has a bug that prevents previews of Brick models."),console.log("Using Edges-only preview in the Inspector"),this.data.steps?(console.log("CHILDREN",this.model.children),this.model.children.forEach(e=>this.hide(e))):this.show(this.model))},play:function(){this.isBuggy&&(this.data.steps?this.model.children.forEach(e=>this.show(e)):this.show(this.model))},show:function(e){e.children[0].visible=!0},hide:function(e){e.children[0].visible=!1},loadModel:function(e,t){let r=this.el,n=this.ldrawLoader;n.separateObjects=!0,n.load(e,e=>{console.log("Construction Steps",e.userData.numConstructionSteps),console.log(e),this.model=e,e.scale.y=-1,t&&this.setStep(t),r.setObject3D("mesh",e),r.emit("model-loaded",{format:"ldraw",model:e})})},setStep:function(e){this.model.traverse(t=>{t.isGroup&&(t.visible=t.userData.constructionStep<=e)})}});let n=AFRAME.primitives.getMeshMixin();AFRAME.registerPrimitive("a-bricks",AFRAME.utils.extendDeep({},n,{defaultComponents:{bricks:{}},mappings:{src:"bricks.src",steps:"bricks.steps"}}))},function(e,t){THREE.LDrawLoader=function(){var e=new THREE.Vector3,t=new THREE.Vector3;function r(e){return/primitive/i.test(e)||"Subpart"===e}function n(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}function a(e,t){return e.colourCode===t.colourCode?0:e.colourCode<t.colourCode?-1:1}function i(e,t,r){e.sort(a);for(var n=[],i=[],o=[],s=new THREE.BufferGeometry,l=null,c=0,u=0,d=0,h=e.length;d<h;d++){var p=e[d],g=p.v0,f=p.v1;if(n.push(g.x,g.y,g.z,f.x,f.y,f.z),3===t){n.push(p.v2.x,p.v2.y,p.v2.z);var m=p.n0||p.faceNormal,v=p.n1||p.faceNormal,E=p.n2||p.faceNormal;i.push(m.x,m.y,m.z),i.push(v.x,v.y,v.z),i.push(E.x,E.y,E.z)}l!==p.material?(null!==l&&s.addGroup(c,u,o.length-1),o.push(p.material),l=p.material,c=d*t,u=t):u+=t}u>0&&s.addGroup(c,1/0,o.length-1),s.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),3===t&&s.setAttribute("normal",new THREE.Float32BufferAttribute(i,3));var b=null;if(2===t?b=new THREE.LineSegments(s,o):3===t&&(b=new THREE.Mesh(s,o)),r){b.isConditionalLine=!0;for(var T=new Float32Array(3*e.length*2),S=new Float32Array(3*e.length*2),C=new Float32Array(3*e.length*2),L=0,_=e.length;L<_;L++){var M=e[L],I=M.c0,w=M.c1,x=(g=M.v0,f=M.v1,3*L*2);T[x+0]=I.x,T[x+1]=I.y,T[x+2]=I.z,T[x+3]=I.x,T[x+4]=I.y,T[x+5]=I.z,S[x+0]=w.x,S[x+1]=w.y,S[x+2]=w.z,S[x+3]=w.x,S[x+4]=w.y,S[x+5]=w.z,C[x+0]=f.x-g.x,C[x+1]=f.y-g.y,C[x+2]=f.z-g.z,C[x+3]=f.x-g.x,C[x+4]=f.y-g.y,C[x+5]=f.z-g.z}s.setAttribute("control0",new THREE.BufferAttribute(T,3,!1)),s.setAttribute("control1",new THREE.BufferAttribute(S,3,!1)),s.setAttribute("direction",new THREE.BufferAttribute(C,3,!1))}return b}function o(e){THREE.Loader.call(this,e),this.parseScopesStack=null,this.materials=[],this.subobjectCache={},this.fileMap=null,this.setMaterials([this.parseColourMetaDirective(new n("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333")),this.parseColourMetaDirective(new n("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))]),this.separateObjects=!1,this.smoothNormals=!0}return n.prototype={constructor:n,seekNonSpace:function(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar)return;this.currentCharIndex++}},getToken:function(){for(var e=this.currentCharIndex++;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"\t"!==this.currentChar);)this.currentCharIndex++;var t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)},getRemainingString:function(){return this.line.substring(this.currentCharIndex,this.lineLength)},isAtTheEnd:function(){return this.currentCharIndex>=this.lineLength},setToEnd:function(){this.currentCharIndex=this.lineLength},getLineNumberString:function(){return this.lineNumber>=0?" at line "+this.lineNumber:""}},o.FINISH_TYPE_DEFAULT=0,o.FINISH_TYPE_CHROME=1,o.FINISH_TYPE_PEARLESCENT=2,o.FINISH_TYPE_RUBBER=3,o.FINISH_TYPE_MATTE_METALLIC=4,o.FINISH_TYPE_METAL=5,o.FILE_LOCATION_AS_IS=0,o.FILE_LOCATION_TRY_PARTS=1,o.FILE_LOCATION_TRY_P=2,o.FILE_LOCATION_TRY_MODELS=3,o.FILE_LOCATION_TRY_RELATIVE=4,o.FILE_LOCATION_TRY_ABSOLUTE=5,o.FILE_LOCATION_NOT_FOUND=6,o.prototype=Object.assign(Object.create(THREE.Loader.prototype),{constructor:o,load:function(e,t,r,n){this.fileMap||(this.fileMap={});var a=this,i=new THREE.FileLoader(this.manager);i.setPath(this.path),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(function(r){a.processObject(r,t,null,e)}),r,n)},parse:function(e,t,r){this.processObject(e,r,null,t)},setMaterials:function(e){return this.parseScopesStack=[],this.newParseScopeLevel(e),this.getCurrentParseScope().isFromParse=!1,this.materials=e,this},setFileMap:function(e){return this.fileMap=e,this},newParseScopeLevel:function(e){var t={};if(e)for(var r=0,n=e.length;r<n;r++){var a=e[r];t[a.userData.code]=a}var i=this.getCurrentParseScope(),o={lib:t,url:null,subobjects:null,numSubobjects:0,subobjectIndex:0,inverted:!1,category:null,keywords:null,currentFileName:null,mainColourCode:i?i.mainColourCode:"16",mainEdgeColourCode:i?i.mainEdgeColourCode:"24",currentMatrix:new THREE.Matrix4,matrix:new THREE.Matrix4,isFromParse:!0,triangles:null,lineSegments:null,conditionalSegments:null,startingConstructionStep:!1};return this.parseScopesStack.push(o),o},removeScopeLevel:function(){return this.parseScopesStack.pop(),this},addMaterial:function(e){var t=this.getCurrentParseScope().lib;return t[e.userData.code]||this.materials.push(e),t[e.userData.code]=e,this},getMaterial:function(e){if(e.startsWith("0x2")){var t=e.substring(3);return this.parseColourMetaDirective(new n("Direct_Color_"+t+" CODE -1 VALUE #"+t+" EDGE #"+t))}for(var r=this.parseScopesStack.length-1;r>=0;r--){var a=this.parseScopesStack[r].lib[e];if(a)return a}return null},getParentParseScope:function(){return this.parseScopesStack.length>1?this.parseScopesStack[this.parseScopesStack.length-2]:null},getCurrentParseScope:function(){return this.parseScopesStack.length>0?this.parseScopesStack[this.parseScopesStack.length-1]:null},parseColourMetaDirective:function(e){var t=null,r=16711935,a=16711935,i=1,s=!1,l=0,c=o.FINISH_TYPE_DEFAULT,u=!0,d=null,h=e.getToken();if(!h)throw'LDrawLoader: Material name was expected after "!COLOUR tag'+e.getLineNumberString()+".";for(var p=null;p=e.getToken();)switch(p.toUpperCase()){case"CODE":t=e.getToken();break;case"VALUE":if((r=e.getToken()).startsWith("0x"))r="#"+r.substring(2);else if(!r.startsWith("#"))throw"LDrawLoader: Invalid colour while parsing material"+e.getLineNumberString()+".";break;case"EDGE":if((a=e.getToken()).startsWith("0x"))a="#"+a.substring(2);else if(!a.startsWith("#")){if(!(d=this.getMaterial(a)))throw"LDrawLoader: Invalid edge colour while parsing material"+e.getLineNumberString()+".";d=d.userData.edgeMaterial}break;case"ALPHA":if(i=parseInt(e.getToken()),isNaN(i))throw"LDrawLoader: Invalid alpha value in material definition"+e.getLineNumberString()+".";(i=Math.max(0,Math.min(1,i/255)))<1&&(s=!0);break;case"LUMINANCE":if(l=parseInt(e.getToken()),isNaN(l))throw"LDrawLoader: Invalid luminance value in material definition"+n.getLineNumberString()+".";l=Math.max(0,Math.min(1,l/255));break;case"CHROME":c=o.FINISH_TYPE_CHROME;break;case"PEARLESCENT":c=o.FINISH_TYPE_PEARLESCENT;break;case"RUBBER":c=o.FINISH_TYPE_RUBBER;break;case"MATTE_METALLIC":c=o.FINISH_TYPE_MATTE_METALLIC;break;case"METAL":c=o.FINISH_TYPE_METAL;break;case"MATERIAL":e.setToEnd();break;default:throw'LDrawLoader: Unknown token "'+p+'" while parsing material'+e.getLineNumberString()+"."}var g=null;switch(c){case o.FINISH_TYPE_DEFAULT:g=new THREE.MeshStandardMaterial({color:r,roughness:.3,envMapIntensity:.3,metalness:0});break;case o.FINISH_TYPE_PEARLESCENT:var f=new THREE.Color(r),m=f.getHSL({h:0,s:0,l:0});m.h=(m.h+.5)%1,m.l=Math.min(1,m.l+.7*(1-m.l)),f.setHSL(m.h,m.s,m.l),g=new THREE.MeshPhongMaterial({color:r,specular:f,shininess:10,reflectivity:.3});break;case o.FINISH_TYPE_CHROME:g=new THREE.MeshStandardMaterial({color:r,roughness:0,metalness:1});break;case o.FINISH_TYPE_RUBBER:g=new THREE.MeshStandardMaterial({color:r,roughness:.9,metalness:0}),u=!1;break;case o.FINISH_TYPE_MATTE_METALLIC:g=new THREE.MeshStandardMaterial({color:r,roughness:.8,metalness:.4});break;case o.FINISH_TYPE_METAL:g=new THREE.MeshStandardMaterial({color:r,roughness:.2,metalness:.85})}return g.transparent=s,g.premultipliedAlpha=!0,g.opacity=i,g.depthWrite=!s,g.polygonOffset=!0,g.polygonOffsetFactor=1,g.userData.canHaveEnvMap=u,0!==l&&g.emissive.set(g.color).multiplyScalar(l),d||((d=new THREE.LineBasicMaterial({color:a,transparent:s,opacity:i,depthWrite:!s})).userData.code=t,d.name=h+" - Edge",d.userData.canHaveEnvMap=!1,d.userData.conditionalEdgeMaterial=new THREE.ShaderMaterial({vertexShader:"\n\tattribute vec3 control0;\n\tattribute vec3 control1;\n\tattribute vec3 direction;\n\tvarying float discardFlag;\n\n\t#include <common>\n\t#include <color_pars_vertex>\n\t#include <fog_pars_vertex>\n\t#include <logdepthbuf_pars_vertex>\n\t#include <clipping_planes_pars_vertex>\n\tvoid main() {\n\t\t#include <color_vertex>\n\n\t\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t// Transform the line segment ends and control points into camera clip space\n\t\tvec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );\n\t\tvec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );\n\t\tvec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\tvec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );\n\n\t\tc0.xy /= c0.w;\n\t\tc1.xy /= c1.w;\n\t\tp0.xy /= p0.w;\n\t\tp1.xy /= p1.w;\n\n\t\t// Get the direction of the segment and an orthogonal vector\n\t\tvec2 dir = p1.xy - p0.xy;\n\t\tvec2 norm = vec2( -dir.y, dir.x );\n\n\t\t// Get control point directions from the line\n\t\tvec2 c0dir = c0.xy - p1.xy;\n\t\tvec2 c1dir = c1.xy - p1.xy;\n\n\t\t// If the vectors to the controls points are pointed in different directions away\n\t\t// from the line segment then the line should not be drawn.\n\t\tfloat d0 = dot( normalize( norm ), normalize( c0dir ) );\n\t\tfloat d1 = dot( normalize( norm ), normalize( c1dir ) );\n\t\tdiscardFlag = float( sign( d0 ) != sign( d1 ) );\n\n\t\t#include <logdepthbuf_vertex>\n\t\t#include <clipping_planes_vertex>\n\t\t#include <fog_vertex>\n\t}\n\t",fragmentShader:"\n\tuniform vec3 diffuse;\n\tuniform float opacity;\n\tvarying float discardFlag;\n\n\t#include <common>\n\t#include <color_pars_fragment>\n\t#include <fog_pars_fragment>\n\t#include <logdepthbuf_pars_fragment>\n\t#include <clipping_planes_pars_fragment>\n\tvoid main() {\n\n\t\tif ( discardFlag > 0.5 ) discard;\n\n\t\t#include <clipping_planes_fragment>\n\t\tvec3 outgoingLight = vec3( 0.0 );\n\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t\t#include <logdepthbuf_fragment>\n\t\t#include <color_fragment>\n\t\toutgoingLight = diffuseColor.rgb; // simple shader\n\t\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t\t#include <tonemapping_fragment>\n\t\t#include <encodings_fragment>\n\t\t#include <fog_fragment>\n\t\t#include <premultiplied_alpha_fragment>\n\t}\n\t",uniforms:{diffuse:{value:new THREE.Color(a)},opacity:{value:i}},transparent:s,depthWrite:!s}),d.userData.conditionalEdgeMaterial.userData.canHaveEnvMap=!1),g.userData.code=t,g.name=h,g.userData.edgeMaterial=d,g},objectParse:function(a){var i,s,l,c=this.getParentParseScope(),u=c.mainColourCode,d=c.mainEdgeColourCode,h=this.getCurrentParseScope(),p=[],g=null,f=null;-1!==a.indexOf("\r\n")&&(a=a.replace(/\r\n/g,"\n"));var m=a.split("\n"),v=m.length,E=0,b=!1,T=null,S=null,C=!1,L=!0,_=!1,M=!0,I="",w=!1,x=this;function N(e,t){var r=e.getToken();t||"16"!==r||(r=u),t&&"24"===r&&(r=d);var n=x.getMaterial(r);if(!n)throw'LDrawLoader: Unknown colour code "'+r+'" is used'+e.getLineNumberString()+" but it was not defined previously.";return n}function F(e){var t=new THREE.Vector3(parseFloat(e.getToken()),parseFloat(e.getToken()),parseFloat(e.getToken()));return x.separateObjects||t.applyMatrix4(h.currentMatrix),t}for(E=0;E<v;E++){var k=m[E];if(0!==k.length)if(b)k.startsWith("0 FILE ")?(this.subobjectCache[T.toLowerCase()]=S,T=k.substring(7),S=""):S+=k+"\n";else{var O=new n(k,E+1);if(O.seekNonSpace(),!O.isAtTheEnd()){var y=O.getToken();switch(y){case"0":var A=O.getToken();if(A)switch(A){case"!LDRAW_ORG":I=O.getToken(),h.triangles=[],h.lineSegments=[],h.conditionalSegments=[],h.type=I,(!c.isFromParse||x.separateObjects&&!r(I))&&(h.groupObject=new THREE.Group,h.groupObject.userData.startingConstructionStep=h.startingConstructionStep),(X=h.matrix).determinant()<0&&(x.separateObjects&&r(I)||!x.separateObjects)&&(h.inverted=!h.inverted),i=h.triangles,s=h.lineSegments,l=h.conditionalSegments;break;case"!COLOUR":(H=this.parseColourMetaDirective(O))?this.addMaterial(H):console.warn("LDrawLoader: Error parsing material"+O.getLineNumberString());break;case"!CATEGORY":g=O.getToken();break;case"!KEYWORDS":var R=O.getRemainingString().split(",");R.length>0&&(f||(f=[]),R.forEach((function(e){f.push(e.trim())})));break;case"FILE":E>0&&(b=!0,T=O.getRemainingString(),S="",C=!1,L=!0);break;case"BFC":for(;!O.isAtTheEnd();){var D=O.getToken();switch(D){case"CERTIFY":case"NOCERTIFY":C="CERTIFY"===D,L=!0;break;case"CW":case"CCW":L="CCW"===D;break;case"INVERTNEXT":_=!0;break;case"CLIP":case"NOCLIP":M="CLIP"===D;break;default:console.warn('THREE.LDrawLoader: BFC directive "'+D+'" is unknown.')}}break;case"STEP":w=!0}break;case"1":var H=N(O),P=parseFloat(O.getToken()),j=parseFloat(O.getToken()),Y=parseFloat(O.getToken()),V=parseFloat(O.getToken()),U=parseFloat(O.getToken()),z=parseFloat(O.getToken()),B=parseFloat(O.getToken()),W=parseFloat(O.getToken()),G=parseFloat(O.getToken()),q=parseFloat(O.getToken()),$=parseFloat(O.getToken()),K=parseFloat(O.getToken()),X=(new THREE.Matrix4).set(V,U,z,P,B,W,G,j,q,$,K,Y,0,0,0,1),J=O.getRemainingString().trim().replace(/\\/g,"/");x.fileMap[J]?J=x.fileMap[J]:J.startsWith("s/")?J="parts/"+J:J.startsWith("48/")&&(J="p/"+J),p.push({material:H,matrix:X,fileName:J,originalFileName:J,locationState:o.FILE_LOCATION_AS_IS,url:null,triedLowerCase:!1,inverted:_!==h.inverted,startingConstructionStep:w}),_=!1;break;case"2":var Q={material:(H=N(O,!0)).userData.edgeMaterial,colourCode:H.userData.code,v0:F(O),v1:F(O)};s.push(Q);break;case"5":Q={material:(H=N(O,!0)).userData.edgeMaterial.userData.conditionalEdgeMaterial,colourCode:H.userData.code,v0:F(O),v1:F(O),c0:F(O),c1:F(O)};l.push(Q);break;case"3":H=N(O);var Z=!C||!M;!0===(L!==h.inverted)?(ee=F(O),te=F(O),re=F(O)):(re=F(O),te=F(O),ee=F(O)),e.subVectors(te,ee),t.subVectors(re,te),ae=(new THREE.Vector3).crossVectors(e,t).normalize(),i.push({material:H,colourCode:H.userData.code,v0:ee,v1:te,v2:re,faceNormal:ae,n0:null,n1:null,n2:null}),!0===Z&&i.push({material:H,colourCode:H.userData.code,v0:ee,v1:re,v2:te,faceNormal:ae,n0:null,n1:null,n2:null});break;case"4":var ee,te,re,ne,ae;H=N(O),Z=!C||!M;!0===(L!==h.inverted)?(ee=F(O),te=F(O),re=F(O),ne=F(O)):(ne=F(O),re=F(O),te=F(O),ee=F(O)),e.subVectors(te,ee),t.subVectors(re,te),ae=(new THREE.Vector3).crossVectors(e,t).normalize(),i.push({material:H,colourCode:H.userData.code,v0:ee,v1:te,v2:re,faceNormal:ae,n0:null,n1:null,n2:null}),i.push({material:H,colourCode:H.userData.code,v0:ee,v1:re,v2:ne,faceNormal:ae,n0:null,n1:null,n2:null}),!0===Z&&(i.push({material:H,colourCode:H.userData.code,v0:ee,v1:re,v2:te,faceNormal:ae,n0:null,n1:null,n2:null}),i.push({material:H,colourCode:H.userData.code,v0:ee,v1:ne,v2:re,faceNormal:ae,n0:null,n1:null,n2:null}));break;default:throw'LDrawLoader: Unknown line type "'+y+'"'+O.getLineNumberString()+"."}}}}b&&(this.subobjectCache[T.toLowerCase()]=S),h.category=g,h.keywords=f,h.subobjects=p,h.numSubobjects=p.length,h.subobjectIndex=0},computeConstructionSteps:function(e){var t=0;e.traverse(e=>{e.isGroup&&(e.userData.startingConstructionStep&&t++,e.userData.constructionStep=t)}),e.userData.numConstructionSteps=t+1},processObject:function(n,a,s,l){var c=this,u=c.newParseScopeLevel();u.url=l;var d=c.getParentParseScope();s&&(u.currentMatrix.multiplyMatrices(d.currentMatrix,s.matrix),u.matrix.copy(s.matrix),u.inverted=s.inverted,u.startingConstructionStep=s.startingConstructionStep);var h=d.currentFileName;null!==h&&(h=d.currentFileName.toLowerCase()),void 0===c.subobjectCache[h]&&(c.subobjectCache[h]=n),c.objectParse(n);var p=0;function g(){if(++p===u.subobjects.length+1)!function(){c.smoothNormals&&"Part"===u.type&&function(e,t){function r(e){return`${~~(100*e.x)},${~~(100*e.y)},${~~(100*e.z)}`}function n(e,t){return`${r(e)}_${r(t)}`}for(var a=new Set,i={},o={},s=[],l=0,c=t.length;l<c;l++){var u=t[l],d=u.v0,h=u.v1;a.add(n(d,h)),a.add(n(h,d))}for(l=0,c=e.length;l<c;l++)for(var p=e[l],g=0,f=3;g<f;g++){var m=(g+1)%3,v=n(d=p["v"+(S=g)],h=p["v"+m]);a.has(v)||(i[v]=p,o[v]=p)}for(;;){var E=Object.keys(i);if(0===E.length)break;l=0;for(var b=[o[E[0]]];l<b.length;){p=b[l];l++;var T=p.faceNormal;null===p.n0&&(p.n0=T.clone(),s.push(p.n0)),null===p.n1&&(p.n1=T.clone(),s.push(p.n1)),null===p.n2&&(p.n2=T.clone(),s.push(p.n2));for(g=0,f=3;g<f;g++){var S;m=(g+1)%3;delete i[v=n(d=p["v"+(S=g)],h=p["v"+m])];var C=n(h,d),L=o[C];if(L){if(Math.abs(L.faceNormal.dot(p.faceNormal))<.25)continue;C in i&&(b.push(L),delete i[C]);for(var _=0;_<3;_++){var M=_,I=(_+1)%3;if(n(L["v"+M],L["v"+I])===C){if(null===L["n"+M]){var w=p["n"+m];L["n"+M]=w,w.add(L.faceNormal)}if(null===L["n"+I]){w=p["n"+S];L["n"+I]=w,w.add(L.faceNormal)}break}}}}}}for(l=0,c=s.length;l<c;l++)s[l].normalize()}(u.triangles,u.lineSegments);var n=!d.isFromParse;if(c.separateObjects&&!r(u.type)||n){const e=u.groupObject;u.triangles.length>0&&e.add(i(u.triangles,3)),u.lineSegments.length>0&&e.add(i(u.lineSegments,2)),u.conditionalSegments.length>0&&e.add(i(u.conditionalSegments,2,!0)),d.groupObject&&(e.name=u.fileName,e.userData.category=u.category,e.userData.keywords=u.keywords,u.matrix.decompose(e.position,e.quaternion,e.scale),d.groupObject.add(e))}else{for(var o=c.separateObjects,s=d.lineSegments,l=d.conditionalSegments,h=d.triangles,p=u.lineSegments,g=u.conditionalSegments,f=u.triangles,m=0,v=p.length;m<v;m++){var E=p[m];o&&(E.v0.applyMatrix4(u.matrix),E.v1.applyMatrix4(u.matrix)),s.push(E)}for(m=0,v=g.length;m<v;m++){var b=g[m];o&&(b.v0.applyMatrix4(u.matrix),b.v1.applyMatrix4(u.matrix),b.c0.applyMatrix4(u.matrix),b.c1.applyMatrix4(u.matrix)),l.push(b)}for(m=0,v=f.length;m<v;m++){var T=f[m];o&&(T.v0=T.v0.clone().applyMatrix4(u.matrix),T.v1=T.v1.clone().applyMatrix4(u.matrix),T.v2=T.v2.clone().applyMatrix4(u.matrix),e.subVectors(T.v1,T.v0),t.subVectors(T.v2,T.v1),T.faceNormal.crossVectors(e,t).normalize()),h.push(T)}}c.removeScopeLevel(),d.isFromParse||c.computeConstructionSteps(u.groupObject);a&&a(u.groupObject)}();else{var n=u.subobjects[u.subobjectIndex];Promise.resolve().then((function(){f(n)})),u.subobjectIndex++}}function f(e){u.mainColourCode=e.material.userData.code,u.mainEdgeColourCode=e.material.userData.edgeMaterial.userData.code,u.currentFileName=e.originalFileName;var t=c.subobjectCache[e.originalFileName.toLowerCase()];if(t)c.processObject(t,(function(t){m(t,e),g()}),e,l);else{var r=e.fileName,n=o.FILE_LOCATION_NOT_FOUND;switch(e.locationState){case o.FILE_LOCATION_AS_IS:n=e.locationState+1;break;case o.FILE_LOCATION_TRY_PARTS:r="parts/"+r,n=e.locationState+1;break;case o.FILE_LOCATION_TRY_P:r="p/"+r,n=e.locationState+1;break;case o.FILE_LOCATION_TRY_MODELS:r="models/"+r,n=e.locationState+1;break;case o.FILE_LOCATION_TRY_RELATIVE:r=l.substring(0,l.lastIndexOf("/")+1)+r,n=e.locationState+1;break;case o.FILE_LOCATION_TRY_ABSOLUTE:e.triedLowerCase?n=o.FILE_LOCATION_NOT_FOUND:(e.fileName=e.fileName.toLowerCase(),r=e.fileName,e.triedLowerCase=!0,n=o.FILE_LOCATION_AS_IS);break;case o.FILE_LOCATION_NOT_FOUND:return void console.warn('LDrawLoader: Subobject "'+e.originalFileName+'" could not be found.')}e.locationState=n,e.url=r;var a=new THREE.FileLoader(c.manager);a.setPath(c.path),a.setRequestHeader(c.requestHeader),a.setWithCredentials(c.withCredentials),a.load(r,(function(t){c.processObject(t,(function(t){m(t,e),g()}),e,l)}),void 0,(function(t){!function(e,t){f(t)}(0,e)}),e)}}function m(e,t){null!==e?c.fileMap[t.originalFileName]=t.url:f(t)}g()}}),o}()}])}));